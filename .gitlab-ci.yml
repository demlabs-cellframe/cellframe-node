variables:
    GIT_SUBMODULE_STRATEGY: recursive

stages:
    - build
    - pack
    - deploy

.ci-polygon:
  tags:
     - ci-polygon
  
.build:  
  extends: .ci-polygon
  stage: build
  image: ubuntu:20.04
  dependencies: []
  artifacts:
      expire_in: 1h
      paths:
        - build_*

.pack:
  extends: .ci-polygon
  image: ubuntu:20.04
  stage: pack
  before_script: /opt/buildtools/prepare_environment.sh
  
.deploy:
  extends: .ci-polygon
  image: ubuntu:20.04
  stage: deploy
  before_script: /opt/buildtools/prepare_environment.sh 
  

cellframe-node_x86_64-linux-gnu:
    extends: .build
    before_script: /opt/buildtools/prepare_environment.sh x86_64-linux-gnu 
    script: ./prod_build/build.sh x86_64-linux-gnu release

cellframe-node-dbg_x86_64-linux-gnu:
    extends: .build
    before_script: /opt/buildtools/prepare_environment.sh x86_64-linux-gnu 
    script: ./prod_build/build.sh x86_64-linux-gnu debug
        

cellframe-node_aarch64-linux-gnu:
    extends: .build
    before_script: /opt/buildtools/prepare_environment.sh aarch64-linux-gnu
    script: ./prod_build/build.sh aarch64-linux-gnu release


cellframe-node-dbg_aarch64-linux-gnu:
    extends: .build
    before_script: /opt/buildtools/prepare_environment.sh aarch64-linux-gnu
    script: ./prod_build/build.sh aarch64-linux-gnu debug
    

pack-deb:
  extends: .pack
  needs: 
    - cellframe-node_x86_64-linux-gnu 
    - cellframe-node_aarch64-linux-gnu 
    - cellframe-node-dbg_x86_64-linux-gnu 
    - cellframe-node-dbg_aarch64-linux-gnu

  script: 
    - ./prod_build/pack.sh x86_64-linux-gnu release
    - ./prod_build/pack.sh x86_64-linux-gnu debug
    - ./prod_build/pack.sh aarch64-linux-gnu release
    - ./prod_build/pack.sh aarch64-linux-gnu debug
    

  artifacts:
    paths:
      - build_*/*.deb

deploy:
  extends: .deploy
  needs: [pack-deb]
  script: 
    - /opt/buildtools/deploy_files.sh pub linux/$CI_COMMIT_REF_NAME/ build_*/*.deb 
    


