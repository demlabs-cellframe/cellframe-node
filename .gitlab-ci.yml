variables:
    GIT_SUBMODULE_STRATEGY: recursive

stages:
    - build
    - pack

cellframe-node_x86_64-linux-gnu:
    tags:
     - ci-polygon
    
    image: ubuntu:20.04
    stage: build
    dependencies: []


    
    before_script: /opt/buildtools/prepare_environment.sh x86_64-linux-gnu 
    script: ./prod_build/build.sh x86_64-linux-gnu
    artifacts:
      expire_in: 1h
      paths:
        - build_*

cellframe-node_aarch64-linux-gnu:
    tags:
     - ci-polygon
    
    image: ubuntu:20.04
    stage: build
    dependencies: []


    
    before_script: /opt/buildtools/prepare_environment.sh aarch64-linux-gnu
    script: ./prod_build/build.sh aarch64-linux-gnu release

cellframe-node_armhf-linux-gnu:
    tags:
     - ci-polygon
    
    image: ubuntu:20.04
    stage: build
    
    before_script: /opt/buildtools/prepare_environment.sh armhf-linux-gnu
    script: ./prod_build/build.sh armhf-linux-gnu release

pack-deb:
  tags:
     - ci-polygon

  stage: pack
  needs: [cellframe-node_x86_64-linux-gnu, cellframe-node_aarch64-linux-gnu, cellframe-node_armhf-linux-gnu]
  image: ubuntu:20.04


  before_script: /opt/buildtools/prepare_environment.sh

  script: 
    - ./prod_build/pack.sh x86_64-linux-gnu release deb
    - ./prod_build/pack.sh aarch64-linux-gnu release deb
    - ./prod_build/pack.sh armhf-linux-gnu release deb

pack-pkg:
  tags:
     - ci-polygon

  stage: pack
  needs: [cellframe-node_x86_64-linux-gnu, cellframe-node_aarch64-linux-gnu, cellframe-node_armhf-linux-gnu]
  image: ubuntu:20.04
  before_script: /opt/buildtools/prepare_environment.sh
  script: 
    - ./prod_build/pack.sh x86_64-linux-gnu release pkg
    - ./prod_build/pack.sh aarch64-linux-gnu release pkg
