variables:
    GIT_SUBMODULE_STRATEGY: recursive

stages:
    - build
    - deploy

.ci-polygon:
  tags:
     - ci-polygon
  
.build:  
  extends: .ci-polygon
  stage: build
  timeout: 3 hours 30 minutes
  dependencies: []
  artifacts:
    paths:
      - build_*/*.deb

.deploy:
  extends: .ci-polygon
  image: amd64/debian:bullseye
  stage: deploy
  before_script: /opt/buildtools/prepare_environment.sh 
  
amd64-darvin:
    extends: .build
    image:  sickcodes/docker-osx:auto
    before_script: /opt/buildtools/prepare_environment.sh x86_64-apple-darvin
    script: 
      - ./prod_build/build.sh x86_64-apple-darvin release
      - ./prod_build/pack.sh x86_64-apple-darvin release

amd64-debian-bullseye:
    extends: .build
    image: amd64/debian:bullseye
    before_script: /opt/buildtools/prepare_environment.sh x86_64-linux-gnu 
    script: 
      - ./prod_build/build.sh x86_64-linux-gnu release
      - ./prod_build/pack.sh x86_64-linux-gnu release

amd64-debian-buster:
    extends: .build
    image: amd64/debian:buster
    before_script: /opt/buildtools/prepare_environment.sh x86_64-linux-gnu 
    script: 
      - ./prod_build/build.sh x86_64-linux-gnu release
      - ./prod_build/pack.sh x86_64-linux-gnu release

armhf-debian-bullseye:
    extends: .build
    image: arm32v7/debian:bullseye

    before_script: /opt/buildtools/prepare_environment.sh armhf-linux-gnu
    script: 
      - ./prod_build/build.sh armhf-linux-gnu release
      - ./prod_build/pack.sh armhf-linux-gnu release

armhf-debian-buster:
    extends: .build
    image: arm32v7/debian:buster

    before_script: /opt/buildtools/prepare_environment.sh armhf-linux-gnu
    script: 
      - ./prod_build/build.sh armhf-linux-gnu release
      - ./prod_build/pack.sh armhf-linux-gnu release


arm64-debian-bullseye:
    extends: .build
    image: arm64v8/debian:bullseye
    before_script: /opt/buildtools/prepare_environment.sh aarch64-linux-gnu
    script: 
      - ./prod_build/build.sh aarch64-linux-gnu release
      - ./prod_build/pack.sh aarch64-linux-gnu release

arm64-debian-buster:
    extends: .build
    image: arm64v8/debian:buster
    before_script: /opt/buildtools/prepare_environment.sh aarch64-linux-gnu
    script: 
      - ./prod_build/build.sh aarch64-linux-gnu release
      - ./prod_build/pack.sh aarch64-linux-gnu release


#cellframe-node-dbg_aarch64-linux-gnu:
#    extends: .build
#    image: arm64v8/ubuntu
#    before_script: /opt/buildtools/prepare_environment.sh aarch64-linux-gnu
#    script: ./prod_build/build.sh aarch64-linux-gnu debug
    
  

.fdeploy:
  extends: .deploy
  needs: 
    - cellframe-node_x86_64-linux-gnu 
 #   - cellframe-node-dbg_x86_64-linux-gnu 
    - cellframe-node_aarch64-linux-gnu 
  #  - cellframe-node-dbg_aarch64-linux-gnu
    - cellframe-node_armhf-linux-gnu 
   # - cellframe-node-dbg_armhf-linux-gnu 
    - cellframe-node_x86_64-apple-darvin

  script: 
    - /opt/buildtools/deploy_files.sh pub linux/$CI_COMMIT_REF_NAME/ build_*/*.deb 
    


