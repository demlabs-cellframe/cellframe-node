# Arbitrage Bypass E2E Test
# Полный сценарий: арбитражные транзакции обходят заблокированные UTXO

name: Arbitrage Transaction Bypasses Blocked UTXO
description: |
  End-to-end test verifying that arbitrage transactions can successfully
  bypass UTXO blocklist while regular transactions are blocked.
  
  This tests the complete workflow:
  1. Token creation with UTXO blocking enabled
  2. Token emission and UTXO creation
  3. UTXO blocking via token_update
  4. Regular transaction failure
  5. Arbitrage transaction success
author: QA Team
tags: [e2e, utxo-blocking, arbitrage, critical]
version: "1.0"

network:
  topology: default

includes:
  - common/networks/single_node.yml
  - common/wallets/create_wallet.yml

setup:
  # Create token with UTXO blocking feature
  - cli: token_decl -net stagenet -token ARBTEST -total 1000000 -flags UTXO_BLOCKING_ENABLED
    save: token_hash
    wait: 3s
  
  # Emit tokens to wallet
  - cli: token_emit -token ARBTEST -value 1000000 -addr {{wallet_addr}}
    save: emission_tx
    wait: 3s
  
  # Create UTXO by making transaction from emission
  - cli: tx_create -token ARBTEST -from_emission {{emission_tx}} -value 500000
    save: utxo_tx
    wait: 5s
  
  # Block the UTXO
  - cli: token_update -net stagenet -token ARBTEST -utxo_blocked_add {{utxo_tx}}:0
    wait: 3s
  
  # Verify UTXO is in blocklist
  - cli: token info -net stagenet -token ARBTEST -history_limit 10
    contains: "{{utxo_tx}}"

test:
  # Step 1: Regular transaction should FAIL (UTXO is blocked)
  - cli: tx_create -net stagenet -token ARBTEST -value 100000
    expect: error
    contains: "UTXO is blocked"
  
  # Step 2: Arbitrage transaction should SUCCESS (bypasses block)
  - cli: tx_create -net stagenet -token ARBTEST -value 100000 -arbitrage
    save: arb_tx
    expect: success
    wait: 3s

check:
  # Verify arbitrage transaction was created
  - cli: tx_history -net stagenet -tx {{arb_tx}}
    contains: "{{arb_tx}}"
  
  # Verify arbitrage marker is present in transaction
  - cli: tx_info -net stagenet -tx {{arb_tx}}
    contains: "arbitrage"
  
  # Verify blocked UTXO still in history
  - cli: token info -net stagenet -name ARBTEST -history_limit 20
    contains: "{{utxo_tx}}"
  
  # Verify token still has blocking enabled
  - cli: token info -net stagenet -name ARBTEST
    contains: "UTXO_BLOCKING_ENABLED"

