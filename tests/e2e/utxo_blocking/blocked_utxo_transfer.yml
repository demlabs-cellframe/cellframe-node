# Blocked UTXO Transfer E2E Test
# Полный сценарий: заблокированные UTXO нельзя потратить

name: Blocked UTXO Cannot Be Spent
description: |
  End-to-end test verifying that blocked UTXO cannot be spent
  in regular transactions, while unblocked UTXO work normally.
  
  Complete workflow:
  1. Create token with UTXO blocking
  2. Create multiple UTXO
  3. Block specific UTXO
  4. Verify blocked UTXO cannot be spent
  5. Verify unblocked UTXO can be spent
author: QA Team
tags: [e2e, utxo-blocking, transfer, critical]
version: "1.0"

network:
  topology: default
  name: stagenet

includes:
  - common/set_net_default.yml

setup:
  # Create two wallets for testing
  - cli: wallet new -w sender
    save: sender_addr
    wait: 1s
  
  - cli: wallet new -w receiver
    save: receiver_addr
    wait: 1s
  
  # Create token (UTXO blocking через token_update, не через флаг)
  - cli: token_decl -token BLOCKTEST -total_supply 10000000 -decimals 18 -signs_total 1 -signs_emission 1
    save: token_hash

  - wait_for_datum: "{{token_hash}}"
  
  # Emit tokens to sender
  - cli: token_emit -token BLOCKTEST -value 10000000 -addr {{sender_addr}}
    save: emission
  
  # Wait for emission
  - wait_for_datum: "{{emission}}"
  
  # Create UTXO #1 (will be blocked)
  - cli: tx_create -token BLOCKTEST -from_emission {{emission}} -value 1000000 -fee 0.1
    save: utxo1
  
  # Wait for UTXO #1
  - wait_for_datum: "{{utxo1}}"
  
  # Create UTXO #2 (will remain unblocked)
  - cli: tx_create -token BLOCKTEST -from_emission {{emission}} -value 1000000 -fee 0.1
    save: utxo2
  
  # Wait for UTXO #2
  - wait_for_datum: "{{utxo2}}"
  
  # Block UTXO #1
  - cli: token_update -token BLOCKTEST -utxo_blocked_add {{utxo1}}:0
    save: block_tx

  - wait_for_datum: "{{block_tx}}"

test:
  # Attempt to spend blocked UTXO - should FAIL
  - cli: tx_create -token BLOCKTEST -from {{utxo1}}:0 -to {{receiver_addr}} -value 500000 -fee 0.1
    expect: error
    contains: "UTXO is blocked"
  
  # Attempt to spend unblocked UTXO - should SUCCESS
  - cli: tx_create -token BLOCKTEST -from {{utxo2}}:0 -to {{receiver_addr}} -value 500000 -fee 0.1
    save: transfer_tx

  - wait_for_datum: "{{transfer_tx}}"

check:
  # Verify blocked UTXO was NOT spent
  - cli: balance -addr {{sender_addr}} -token BLOCKTEST
    contains: "1000000"  # Blocked UTXO still in balance
  
  # Verify unblocked UTXO WAS spent
  - cli: tx_history -tx {{transfer_tx}}
    contains: "{{transfer_tx}}"
  
  # Verify receiver got tokens from unblocked UTXO
  - cli: balance -addr {{receiver_addr}} -token BLOCKTEST
    contains: "500000"
  
  # Verify blocklist still contains blocked UTXO
  - cli: token info -name BLOCKTEST -history_limit 10
    contains: "{{utxo1}}"

