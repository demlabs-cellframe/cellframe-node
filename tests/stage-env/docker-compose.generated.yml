x-cf-node-template:
  build:
    context: .
    dockerfile: Dockerfile.cellframe
    args:
      CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      BUILD_TYPE: ${BUILD_TYPE:-debug}
  image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
  container_name: ${COMPOSE_PROJECT_NAME:-cellframe}-${NODE_TYPE:-node}-${NODE_ID:-1}
  hostname: ${COMPOSE_PROJECT_NAME:-cellframe}-${NODE_TYPE:-node}-${NODE_ID:-1}
  networks:
    stagenet:
      ipv4_address: ${NODE_IP:-172.20.0.10}
  ports:
  - ${HTTP_PORT:-8079}:8079
  volumes:
  - ./cache/configs/node${NODE_ID:-1}/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
  - ./cache/configs/node${NODE_ID:-1}/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
  - ./cache/configs/node${NODE_ID:-1}/network:/opt/cellframe-node/etc/network
  - ./cache/data/node${NODE_ID:-1}:/opt/cellframe-node/var
  - ./cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
  - ./cache/crash-artifacts/node${NODE_ID:-1}:/crash-artifacts/node-${NODE_ID:-1}
  - ./cache/cellframe-packages:/var/cache/cellframe-packages
  ulimits:
    core: -1
  environment:
    NODE_ID: ${NODE_ID:-1}
    NODE_ROLE: ${NODE_ROLE:-root}
    NODE_TYPE: ${NODE_TYPE:-node}
    NODE_IP: ${NODE_IP:-172.20.0.10}
    NETWORK_NAME: ${NETWORK_NAME:-stagenet}
    DAP_DEBUG: ${DAP_DEBUG:-1}
    CELLFRAME_DEBUG: ${CELLFRAME_DEBUG:-1}
  restart: unless-stopped
  healthcheck:
    test:
    - CMD
    - sh
    - -c
    - pgrep -f cellframe-node > /dev/null
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 30s
services:
  prometheus:
    image: prom/prometheus:latest
    container_name: cf-prometheus
    ports:
    - 9090:9090
    volumes:
    - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    - prometheus-data:/prometheus
    command:
    - --config.file=/etc/prometheus/prometheus.yml
    - --storage.tsdb.path=/prometheus
    - --web.console.libraries=/etc/prometheus/console_libraries
    - --web.console.templates=/etc/prometheus/consoles
    - --storage.tsdb.retention.time=200h
    - --web.enable-lifecycle
    networks:
    - stagenet
    profiles:
    - monitoring
  grafana:
    image: grafana/grafana:latest
    container_name: stagenet-grafana
    ports:
    - 3000:3000
    volumes:
    - grafana-data:/var/lib/grafana
    - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    environment:
    - GF_SECURITY_ADMIN_PASSWORD=admin
    - GF_USERS_ALLOW_SIGN_UP=false
    networks:
    - stagenet
    profiles:
    - monitoring
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.tests
    container_name: stagenet-runner
    volumes:
    - ./tests:/tests:ro
    - ./results:/results
    - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
    - NETWORK_NAME=${NETWORK_NAME:-stagenet}
    - NODE_DISCOVERY=docker
    - COMPOSE_PROJECT=${COMPOSE_PROJECT_NAME:-stagenet}
    networks:
    - stagenet
    profiles:
    - tests
    command:
    - sh
    - -c
    - python3 /tests/discover_nodes.py && python3 /tests/run_all.py
  node-1:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-1
    environment:
      NODE_ID: '1'
      NODE_ROLE: root
      NODE_TYPE: root_nodes
      NODE_IP: 172.20.0.10
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-1
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.10
    ports:
    - 8079:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node1/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node1/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node1/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node1:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node1:/crash-artifacts/node-1
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
  node-2:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-2
    environment:
      NODE_ID: '2'
      NODE_ROLE: root
      NODE_TYPE: root_nodes
      NODE_IP: 172.20.0.11
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-2
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.11
    ports:
    - 8080:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node2/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node2/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node2/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node2:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node2:/crash-artifacts/node-2
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
  node-3:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-3
    environment:
      NODE_ID: '3'
      NODE_ROLE: root
      NODE_TYPE: root_nodes
      NODE_IP: 172.20.0.12
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-3
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.12
    ports:
    - 8081:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node3/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node3/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node3/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node3:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node3:/crash-artifacts/node-3
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
  node-4:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-4
    environment:
      NODE_ID: '4'
      NODE_ROLE: master
      NODE_TYPE: master_nodes
      NODE_IP: 172.20.0.13
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-4
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.13
    ports:
    - 8082:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node4/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node4/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node4/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node4:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node4:/crash-artifacts/node-4
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
  node-5:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-5
    environment:
      NODE_ID: '5'
      NODE_ROLE: master
      NODE_TYPE: master_nodes
      NODE_IP: 172.20.0.14
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-5
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.14
    ports:
    - 8083:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node5/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node5/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node5/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node5:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node5:/crash-artifacts/node-5
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
  node-6:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-6
    environment:
      NODE_ID: '6'
      NODE_ROLE: master
      NODE_TYPE: master_nodes
      NODE_IP: 172.20.0.15
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-6
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.15
    ports:
    - 8084:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node6/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node6/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node6/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node6:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node6:/crash-artifacts/node-6
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
  node-7:
    build:
      args:
        BUILD_TYPE: ${BUILD_TYPE:-debug}
        CELLFRAME_VERSION: ${CELLFRAME_VERSION:-latest}
      context: .
      dockerfile: Dockerfile.cellframe
    container_name: cellframe-stage-node-7
    environment:
      NODE_ID: '7'
      NODE_ROLE: full
      NODE_TYPE: full_nodes
      NODE_IP: 172.20.0.16
      NETWORK_NAME: stagenet
      DAP_DEBUG: '1'
      CELLFRAME_DEBUG: '1'
    healthcheck:
      interval: 10s
      retries: 3
      start_period: 30s
      test:
      - CMD
      - sh
      - -c
      - pgrep -f cellframe-node > /dev/null
      timeout: 5s
    hostname: cellframe-stage-node-7
    image: cf-node:${BUILD_TYPE:-debug}-${CELLFRAME_VERSION:-latest}
    networks:
      stagenet:
        ipv4_address: 172.20.0.16
    ports:
    - 8085:8079
    restart: unless-stopped
    ulimits:
      core: -1
    volumes:
    - ./../testing/cache/configs/node7/cellframe-node.cfg:/opt/cellframe-node/etc/cellframe-node.cfg
    - ./../testing/cache/configs/node7/cellframe-node.cfg.d:/opt/cellframe-node/etc/cellframe-node.cfg.d
    - ./../testing/cache/configs/node7/network:/opt/cellframe-node/etc/network
    - ./../testing/cache/data/node7:/opt/cellframe-node/var
    - ./../testing/cache/configs/shared/ca:/opt/cellframe-node/share/ca:ro
    - ./../testing/cache/crash-artifacts/node7:/crash-artifacts/node-7
    - ./../testing/cache/cellframe-packages:/var/cache/cellframe-packages
networks:
  stagenet:
    driver: bridge
    ipam:
      config:
      - subnet: 172.20.0.0/16
        gateway: 172.20.0.1
volumes:
  prometheus-data: null
  grafana-data: null
