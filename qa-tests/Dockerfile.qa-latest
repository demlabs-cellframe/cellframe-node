# Cellframe Node QA Testing Container - Latest Internal Build
# Purpose: Automated testing with latest master build (5.5-0)
# Based on QA_SPECIFICATION_LINUX.md

FROM debian:bullseye

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install basic dependencies required for testing
RUN apt-get update && apt-get install -y \
    wget \
    curl \
    ca-certificates \
    gnupg \
    procps \
    net-tools \
    iproute2 \
    iputils-ping \
    systemd \
    systemd-sysv \
    sudo \
    less \
    pv \
    psmisc \
    logrotate \
    irqbalance \
    xz-utils \
    libmagic1 \
    bc \
    dpkg \
    bash \
    && rm -rf /var/lib/apt/lists/*

# Download and install latest cellframe-node package
RUN wget -q https://internal-pub.cellframe.net/linux/cellframe-node/master/cellframe-node-5.5-0-amd64.deb -O /tmp/cellframe-node.deb && \
    dpkg -i /tmp/cellframe-node.deb || true && \
    apt-get update && apt-get install -f -y && \
    rm /tmp/cellframe-node.deb

# Copy QA test scripts
COPY test-suite.sh /opt/qa-tests/test-suite.sh
COPY health-check.sh /opt/qa-tests/health-check.sh
RUN chmod +x /opt/qa-tests/*.sh

# Set working directory
WORKDIR /opt/qa-tests

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /opt/qa-tests/health-check.sh || exit 1

# Default command: run full test suite
CMD ["/opt/qa-tests/test-suite.sh"]

