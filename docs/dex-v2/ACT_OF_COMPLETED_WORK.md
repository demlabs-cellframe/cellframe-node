## Акт выполненных работ: DEX v2 (SRV_DEX)

Документ фиксирует фактическое текущее состояние реализации DEX v2 на базе сервиса `SRV_DEX`, опираясь на код и поведение системы. Используется для составления чейнджлога и для проведения поэтапного ревью отдельных областей без перегрузки полным ревью всего модуля.

### Содержание
- Архитектура и жизненный цикл ордера
- Модель данных и кэш (индексы, согласованность, реорг-устойчивость)
- Формирование транзакций (покупка, мульти-покупка, обновление ордера)
- Верификация транзакций (fast-path обновления, проверки соответствия)
- Комиссии (типы, расчёт, возврат излишков, согласование compose/verifier)
- Каноникализация пар и логика стакана
- CLI-команды и пользовательские сценарии
- Логи и UX
- Ограничения/допущения
- Оставшиеся задачи и точки ревью
- Краткий чейнджлог

## Архитектура и жизненный цикл ордера

- **Сервис**: `SRV_DEX` реализует условные обмены на базе `OUT_COND(SRV_DEX)` и их потребления через `IN_COND`.
- **Единица ордера**: выход `OUT_COND(SRV_DEX)` с параметрами (сети/токены, цена, объём, флаги, `order_root_hash`, `min_fill`, `ttl`, и т.п.).
- **Жизненный цикл**:
  - Создание ордера (первый `OUT_COND`), `order_root_hash` — хеш первой транзакции цепочки ордера.
  - Частичное/полное исполнение: одна или несколько транзакций `EXCHANGE`, каждая потребляет хвост (`tail`) через `IN_COND` и может создавать новый остаточный `OUT_COND` (residual) либо новый ордер «покупателя» (buyer leftover).
  - Обновление владельцем: 1-транзакционный апдейт — потребление текущего хвоста и создание нового `OUT_COND` с изменёнными параметрами в той же транзакции.
  - Инвалидация: отсутствие нового `OUT_COND` после потребления хвоста закрывает цепочку.

## Модель данных и кэш

- **Структура записи**: `dex_order_cache_entry_t` хранит активный `OUT_COND` и метаданные: `order_root_hash`, `tail`, `seller_addr`, сети/токены, каноническая пара, `side` (ASK/BID), `rate` (канонический QUOTE/BASE), объём, `ts_created`, флаги, и т.д.
- **Каноникализация пары**: для каждой пары вычисляется каноническое представление `BASE/QUOTE`. Поле `side` отражает, что ордер продаёт: `ASK` — продаёт BASE, `BID` — продаёт QUOTE. Цена `rate` хранится как `QUOTE/BASE`.
- **Индексы кэша**:
  - `root` (основной): `order_root_hash → entry` (uthash).
  - `tail`: `tail_hash → entry` (uthash) для быстрых переходов по текущему хвосту.
  - `pair` (`dex_pair_index_t`): ключ — каноническая пара; содержит два упорядоченных подсписка (`uthash` с `HASH_ADD_INORDER`):
    - `asks`: ордера, продающие BASE, отсортированы по `rate` по возрастанию.
    - `bids`: ордера, продающие QUOTE, отсортированы по `rate` по возрастанию (при выводе стакана для UX — по убыванию).
  - `seller_addr` (`dex_seller_index_t`): индекс ордеров конкретного продавца.
- **Вставка/удаление**: централизовано через `s_dex_cache_upsert(...)` и единообразные помощники для удаления. Обеспечивается синхронное обновление всех индексов.
- **Реорг-устойчивость**: обработчик уведомлений леджера корректно обрабатывает как добавления (`a`), так и откаты (`d`):
  - При `EXCHANGE` учитываются все `IN_COND` для точной актуализации кэша.
  - Отдельно различаются «апдейт владельца» и «buyer leftover» по совпадению адреса продавца.
  - При откате восстанавливаются предыдущие состояния ордеров и удаляются ордера-потомки.
  - Исторические данные в горячий кэш не попадают.

## Формирование транзакций

### Покупка (single)
- Функция: `s_dex_tx_create_exchange(...)`.
- Потребляет хвост целевого ордера, перечисляет эквивалент покупаемой суммы продавцу в `buy_token`, создаёт остаточный `OUT_COND` (если частичное исполнение), возвращает сдачу покупателю.
- Комиссии добавляются отдельными выходами согласно типам (см. раздел «Комиссии»).
- Реализован возврат излишков нативного бандла с учётом фактически задействованных native-комиссий.

### Покупка (multi)
- Функция: `s_dex_tx_create_exchange_multi(...)`.
- Поглощает несколько SELL-ордеров для удовлетворения запроса покупателя; корректно распределяет выплаты/комиссии и остатки.
- Для «buyer leftover» требуется явный `leftover_rate` (или `min_rate` в авто-режиме), чтобы избежать неоднозначностей.

### Обновление ордера владельцем (1-TX)
- Функция: `dap_chain_net_srv_dex_update(...)`.
- Одна входящая условная ссылка на текущий хвост + один новый `OUT_COND(SRV_DEX)` с обновлёнными параметрами в той же транзакции.
- Нет выплат продавцу в `buy_token`. Недопустим «собственный» сервисный фии в `buy_token` (own-fee) — только native/validator.
- Гарантируется сохранение `root/seller/nets/tokens`; допускаются изменения `rate`, `value`, и др. разрешённые параметры.

## Верификация транзакций

- Функция: `s_dex_verificator_callback(...)`.
- **Ограничение**: не более одного `OUT_COND(SRV_DEX)` на транзакцию.
- **Резидуал**: при частичном исполнении параметры нового `OUT_COND` должны соответствовать исходному (совпадение `order_root_hash`, `flags`, `min_fill` и т.п.).
- **Проверка выплат покупателю**: точная, с учётом всех видов комиссий; исключены некорректные суммирования.
- **Fast-path обновления**: допускается 1-TX обновление владельцем при выполнении условий: один `IN_COND` и один `OUT_COND(SRV_DEX)`, совпадают `root/seller/nets/tokens`, нет выплат продавцу в `buy_token`, нет own-fee сервиса.

## Комиссии

- **Типы**:
  - **Validator/native**: всегда в нативном токене сети.
  - **Service (DEX)**: native-fixed, native-percent, own-fixed, own-percent; придётся в `native` или в `buy_token` в зависимости от типа.
- **Согласование compose/verifier**:
  - В single- и multi-транзакциях расчёт комиссий унифицирован и соответствует проверкам верификатора.
  - При наличии отдельного нативного бандла для комиссий реализован точный cashback: возврат, равный фактически использованным native-комиссиям (validator + network + service_native, если применимо).
  - Для 1-TX обновления: разрешены только validator/native комиссии, запрещены own-fee (выплаты в `buy_token` на сервис).

## Каноникализация пар и логика стакана

- **Пара** всегда приводится к каноническому виду `BASE/QUOTE`. Противоположная сторона отражается через `side` (ASK/BID).
- **Цена** хранится как канонический `QUOTE/BASE`.
- **Стакан**:
  - Агрегация по «бинам» цены (`-tick`/`-tick_price`) и подсчёт кумулятивных объёмов.
  - Сортировка: `asks` по возрастанию, `bids` по убыванию при выводе.
  - Сводки: `best_ask`, `best_bid`, `mid`, `spread`.

## CLI-команды и пользовательские сценарии

- **order update**: 1-TX обновление параметров ордера владельцем.
- **orderbook**: стакан по паре с глубиной, бинингом цены и кумулятивами.
- **market_rate**: SPOT/VWAP/OHLC по паре за период (скан леджера on-demand), топ-уровень: `volume_base`, `volume_quote`, `trades`.
- **tvl**: суммарный объём активных ордеров по токену.
- **spread**: `best_ask`, `best_bid`, `spread` по паре.
- **volume**: объём торгов по паре за период, бакетирование по времени с `first_ts`/`last_ts`.
- **slippage**: моделирование исполнения на заданную величину; вывод: `effective_price` (VWAP), `best_ask`/`best_bid`, `slippage`, `slippage_pct`, `filled_base`, `spent_quote`, `fully_filled`. Параметр `-side`.
- **orders/status**: используют только `-pair A/B`, вход каноникализируется автоматически. Старые `-token_sell/-token_buy` удалены.

## Логи и UX

- В уведомлениях леджера теперь явно маркируется `UPDATE` (в логах `type=EXCHANGE(UPDATE)`).

## Ограничения/допущения

- Горячий кэш хранит только активные ордера; исторические данные запрашиваются по требованию через скан леджера.
- FIFO при равенстве цен обеспечивается `ts_created` и порядком включения.
- Допускаются длительные ответы для исторических команд (в обмен на простоту и компактность кэша).

## Оставшиеся задачи и точки ревью

- Логи: явная маркировка `UPDATE` в `notify` и бóльшая детализация.
- Документация: дополнить `CLI.md` и `DEX_v2_Usage_Examples.md` разделом `slippage`; отметить в `MARKET_COMMANDS_PLAN.md` как реализованное.
- Юнит/интеграционные тесты: покрытие верификатора, кэша (включая реорги), комиссий и CLI.
- Косметика/рефакторинг: локальные упрощения и единообразие стиля, без изменения логики.

## Краткий чейнджлог (по высоким уровням)

- Каноникализация пар, введение `side`, хранение `rate` в `QUOTE/BASE`.
- Индекс `pair` разбит на `asks`/`bids` с упорядочиванием; введён индекс по `seller_addr`.
- Единая логика вставки/удаления в индексы, улучшенная реорг-устойчивость.
- Верефикатор: жёсткое ограничение в 1 `OUT_COND(SRV_DEX)` на транзакцию, точная проверка выплат покупателю, fast-path для 1-TX обновлений.
- Покрыты команды: `order update`, `orderbook`, `market_rate`, `tvl`, `spread`, `volume`, `slippage`; переход на `-pair`.
- Расчёт комиссий согласован; реализован точный cashback нативного бандла.

## Подробный чейнджлог

- Архитектура/модель:
  - Канон пар BASE/QUOTE; у ордера `side` (ASK — продаёт BASE, BID — продаёт QUOTE); `rate` в каноне QUOTE/BASE.
  - В запись кэша добавлены: `ts_created` (FIFO), канон‑ключ пары, `side`.

- Верификатор (`s_dex_verificator_callback`):
  - Не более одного `OUT_COND(SRV_DEX)` на TX.
  - Резидуал: параметры совпадают с исходным (кроме `value`), `order_root_hash` проверяется как `first_tx_hash` цепочки.
  - Выплаты проверяются покомпонентно для каждого входа (по адресу продавца и `buy_token`).
  - Удалены агрегатные равенства сумм; вместо них — точные проверки по каждому продавцу с учётом комиссий.
  - Fast‑path обновления владельцем: 1 `IN_COND` + 1 `OUT_COND(SRV_DEX)` с тем же `root/seller/nets/tokens`; нет выплат продавцу в `buy_token`; запрещён сервисный own‑fee; разрешены только нативные комиссии.
  - Expiry: запрет использования просроченного ордера не‑владельцем.

- Compose: `s_dex_tx_create_exchange` и `s_dex_tx_create_exchange_multi`:
  - Поддержка фактического удержания нативных комиссий при `sell == native` (network + validator + service_native).
  - Точный native‑cashback при отдельном наборе fee‑входов (возврат излишка покупателю).
  - Service fee: расчёт и выводы по типам (native/own, fixed/percent); own‑fee в `buy_token`.
  - `purchase_multi`: учёт own‑fee в сдаче `buy_token`; добавлена оценка service native fee в набор входов.

- Кэш/индексы:
  - Единая точка апдейта `s_dex_cache_upsert(...)`; атомарная переразметка индексов через `s_dex_indexes_remove_all[_ex]` и `s_dex_indexes_insert_all`.
  - Индекс `pair`: `dex_pair_index_t` с `asks`/`bids`, оба — `HASH_ADD_INORDER` по цене (ASC), FIFO по `ts_created`.
  - Индекс `tail`: прямой O(1) доступ для актуализации.
  - Индекс `seller`: упорядочен по `ts_created`, затем `root`.
  - Нотификации леджера: корректная обработка `a`/`d` включая резидуал IN[0], удаление потреблённых хвостов, восстановление при реоргах, различение owner‑update и buyer leftover.
  - Исправление: инкремент `l_in_idx` перемещён внутрь цикла обработки входов.

- CLI:
  - Переход на `-pair BASE/QUOTE` для `orders` и `status`; авто‑канонизация входа.
  - `orderbook`: бининг (`-tick_price`/`-tick`), кумулятивы, сортировки (asks ASC, bids DESC), сводка `best_ask/best_bid/mid/spread` и `summary`.
  - `market_rate`: SPOT/VWAP + `ohlc[]` при `-bucket`, верхний уровень включает `volume_base`, `volume_quote`, `trades`.
  - `volume`: суммарные метрики + бакеты `buckets[]` с `first_ts/last_ts`.
  - `tvl`, `spread` реализованы по кэшу.
  - `slippage`: моделирование исполнения (buy/sell), поля: `effective_price`, `best_ask|best_bid`, `slippage`, `slippage_pct`, `filled_base`, `spent_quote`, `fully_filled`.
  - `order update`: 1‑TX; проверка владельца в билдере; только native/validator fee.
  - `purchase_auto`: использует `min_rate` как порог и ставку для leftover.
  - `cancel_all_by_seller`, `orders_by_seller`, `status_by_seller`, `history_by_seller` — на базе индекса продавца.

- Комиссии:
  - Единая схема с верификатором; точный cashback для single/multi; удержание фактических native fees.
  - Запрет own‑fee в 1‑TX update.

- Логи/UX:
  - В нотификациях для EXCHANGE пометка `UPDATE`, если это апдейт владельца.

- Документация:
  - Обновлены `CLI.md`, `DEX_v2_CLI_Reference.md`, `IMPLEMENTATION_PLAN.md`, `MARKET_COMMANDS_PLAN.md`, `DEX_v2_Usage_Examples.md` (включая `slippage`).

- Исправления/чистка:
  - Исправлена опечатка `SERIVCE_FEE_NATIVE_PERCENT` → `SERVICE_FEE_NATIVE_PERCENT`.
  - Добавлены недостающие forward‑declarations (`s_dex_tx_put` и пр.).
  - Устранены несоответствия после переименований bucket→index; удалены устаревшие поля структур.

---

Этот документ служит «мапой» для дальнейшего точечного ревью. Предлагается идти сверху вниз: сначала верификация и комиссии, затем кэш и реорги, затем CLI и UX.


