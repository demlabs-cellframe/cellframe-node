flowchart LR

subgraph EX_MULTI_NEW_BUYER_ORDER["TX_EXCHANGE (all sellers closed + new buyer order)"]
  direction TB
  PREV1["Prev TX1: OUT_COND V1"]
  PREV2["Prev TX2: OUT_COND V2"]
  IN1["IN_COND 1 (full)"]
  IN2["IN_COND 2 (full)"]
  CALC["Calc:<br/>Buy capacity C_total (in sell token)<br/>SumS = ΣV_i<br/>L_buy = max(0, C_total - SumS)"]
  OUT_PAY_SELLERS["Σ OUT_EXT seller_i: + (V_i*rate_i)"]
  OUT_PAY_BUYER["OUT_EXT buyer: +SumS' (sell token)"]
  OUT_NEW_ORDER["NEW OUT_COND(SRV_DEX): V_new = L_buy (acts as order)"]
  FEES["Fees"]
  PREV1 --> IN1
  PREV2 --> IN2
  IN1 --> CALC
  IN2 --> CALC
  CALC --> OUT_PAY_SELLERS
  CALC --> OUT_PAY_BUYER
  CALC --> FEES
  CALC --> OUT_NEW_ORDER
end











